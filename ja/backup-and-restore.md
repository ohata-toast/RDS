## Database > RDS for MySQL > バックアップおよび復元

## バックアップ

障害状況に備えて、DBインスタンスのデータベースを復旧できるように事前に準備することができます。必要な時にWebコンソールでバックアップを実行したり、定期的にバックアップが実行されるように設定できます。バックアップが実行されている間は当該DBインスタンスのストレージのパフォーマンス低下が発生する可能性があります。サービスに影響を与えないように、サービスの負荷が少ない時間にバックアップすることを推奨します。バックアップによるパフォーマンス低下を望まない場合は、高可用性構成を使用したり、リードレプリカでバックアップを実行することもできます。

> [参考]
> 高可用性DBインスタンスは予備マスターでバックアップが行われ、マスターのストレージパフォーマンス低下が発生しません。

RDS for MySQLでは、Percona XtraBackupを利用してデータベースをバックアップします。外部MySQLのバックアップで復元したりRDS for MySQLのバックアップで復元するにはRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。DBエンジンバージョン別のPercona XtraBackupバージョンは次のとおりです。

| MySQLバージョン | XtraBackupバージョン |
|------------|-----------------|
| 5.7.15     | 2.4.28          |
| 5.7.19     | 2.4.28          |
| 5.7.26     | 2.4.28          |
| 5.7.33     | 2.4.28          |
| 5.7.37     | 2.4.28          |
| 8.0.18     | 8.0.32          |
| 8.0.23     | 8.0.32          |
| 8.0.28     | 8.0.32          |
| 8.0.32     | 8.0.32          |
| 8.0.33     | 8.0.33          |
| 8.0.34     | 8.0.34          |
| 8.0.35     | 8.0.35          |

* XtraBackupのインストールに関する詳しい説明はPercona Webサイトを参照します。
    * https://www.percona.com/doc/percona-xtrabackup/2.4/index.html
    * https://www.percona.com/doc/percona-xtrabackup/8.0/index.html

> [参考]
> 2023年8月17日XtraBackupユーティリティのバージョンがアップグレードされました。以前バックアップに使用されたXtraBackupバージョンはWebコンソールで確認できます。

백업 시에 적용되는 설정 항목은 다음과 같으며, 자동 백업 및 수동 백업 시에 모두 적용됩니다.

**テーブルロックの使用**

* `FLUSH TABLES WITH READ LOCK`構文を実行するかどうかを設定します。
* テーブルロックを使用すると、バックアップデータの一貫性を保証するために、バックアップ時に定期的に`FLUSH TABLES WITH READ LOCK`構文を実行します。FLUSH TABLES WITH READ LOCK`構文の実行に失敗した場合、バックアップに失敗します。
* バックアップが実行される間、DMLクエリの負荷が多い場合、テーブルロックを無効にすることができます。テーブルロックを使用しない場合、`FLUSH TABLES WITH READ LOCK`構文を実行しないため、DML負荷が多くてもバックアップが失敗しません。하지만 테이블 잠금을 사용하지 않은 백업은 백업 데이터의 일관성이 보장되지 않을 수 있으며, 이에 따라 테이블 잠금을 사용하지 않고 생성된 백업 및 테이블 잠금을 사용하지 않도록 설정된 DB 인스턴스에 대해 복원 및 복제 과정을 포함한 일부 작업을 지원하지 않습니다.

**クエリ遅延待機時間(秒)**

* テーブルロックを使用する場合、`FLUSH TABLES WITH READ LOCK`構文の待機時間を設定します。クエリ遅延待機時間だけ`FLUSH TABLES WITH READ LOCK`構文が待機します。0～21,600秒まで設定できます。長く設定するほど、DMLクエリの負荷によるバックアップ失敗の可能性を減らすことができますが、全体のバックアップ時間が長くなる可能性があります。

### 手動バックアップ

特定の時点のデータベースを永久に保存するには、Webコンソールから手動でバックアップを実行することができます。手動バックアップは自動バックアップと異なり、明示的にバックアップを削除しない限り、DBインスタンスが削除されるときと同じように削除されません。手動バックアップの場合、バックアップの名前を入力する必要があり、下記のような制約があります。

* バックアップ名はリージョンごとに固有の名前でなければなりません。
* バックアップ名は1～100文字の間の英字、数字、一部の記号（-、_、.）のみ使用でき、最初の文字は英字のみ使用できます。

### 自動バックアップ

수동으로 백업을 수행시키는 경우 외에도 복원 작업을 위한 필요 또는 자동 백업 스케줄 사용 등에 따라 자동으로 백업이 수행될 수 있습니다. 자동 백업은 DB 인스턴스와 생명 주기가 동일합니다. DB 인스턴스가 삭제되면 보관된 자동 백업은 모두 삭제됩니다. 자동 백업에서 지원하는 설정 항목은 아래와 같습니다.

**자동 백업 허용**

* 자동 백업을 허용하지 않을 시 모든 자동 백업의 수행이 차단되며, 필요에 의해 백업이 수행될 가능성이 있는 복원, 복제 과정을 포함한 일부 작업을 지원하지 않습니다. 또한 아래의 자동 백업 관련 항목들에 대해 설정이 불가능합니다.

**자동 백업 보관 기간**

* 자동 백업을 백업 스토리지에 저장하는 기간을 설정합니다. 최대 730일까지 보관할 수 있으며, 자동 백업 보관 기간이 변경되면 보관 기간이 지난 자동 백업 파일은 바로 삭제됩니다.

**자동 백업 복제 리전**

* 자동 백업 파일을 다른 리전의 백업 스토리지로 복제되도록 설정합니다. 자동 백업 복제 리전은 재해 복구(disaster recovery)를 위한 기능으로 원본 리전의 자동 백업파일을 대상 리전으로 동일하게 복제하고 관리합니다. 복제는 백그라운드에서 일정 주기마다 진행됩니다. 자동 백업 복제 리전을 설정하면 리전 간 복제 트래픽 과금이 청구되며, 대상 리전에 백업 스토리지 사용량에 대한 과금이 추가로 청구됩니다.

**자동 백업 재시도 횟수**

* DML 쿼리 부하 또는 여러 다양한 이유로 자동 백업이 실패한 경우 재시도하도록 설정할 수 있습니다. 최대 10회까지 재시도할 수 있습니다. 재시도 횟수가 남아 있더라도 자동 백업 수행 시간 설정에 따라 재시도하지 않을 수 있습니다.

**자동 백업 스케줄 사용**

* 자동 백업 스케줄 사용 시 설정한 자동 백업 수행 시간에 자동으로 백업이 수행됩니다.

**バックアップ実行時間**

* 백업이 자동으로 스케줄 되는 시간을 설정할 수 있습니다.バックアップ開始時刻とバックアップウィンドウ、バックアップ再試行有効期限で構成されます。バックアップ実行時間は重複しないように複数回設定できます。バックアップ開始時刻を基準に、バックアップウィンドウ内のある時点でバックアップを実行します。バックアップウィンドウはバックアップの総実行時間とは関係ありません。バックアップにかかる時間はデータベースのサイズに比例し、サービス負荷によって異なります。バックアップが失敗した場合、バックアップ再試行期限を超えなければ、バックアップ再試行回数に基づいてバックアップを再試行します。

自動バックアップの名前は`{DBインスタンスの名前}_yyyy-MM-dd-HH-mm`の形で付与されます。

> [注意]
> 前のバックアップが終了していないなど、バックアップを実行できない状況ではバックアップが実行されない場合があります。

### バックアップストレージおよび課金

すべてのバックアップファイルは、内部オブジェクトストレージにアップロードして保存します。手動バックアップの場合、別途削除するまで永続的に保存され、バックアップ容量に応じてオブジェクトストレージの料金が発生します。自動バックアップの場合、設定した保管期間だけ保存され、自動バックアップファイルの全体サイズのうち、DBインスタンスのストレージサイズを超過した容量に対して課金されます。バックアップファイルが保存されている内部オブジェクトストレージに直接アクセスすることはできず、バックアップファイルが必要な場合は、NHN Cloudのオブジェクトストレージにバックアップファイルをエクスポートできます。

### バックアップのエクスポート

内部オブジェクトストレージに保存されたバックアップファイルをNHN Cloudのユーザーオブジェクトストレージにエクスポートできます。手動バックアップまたは自動バックアップファイルをエクスポートしたり、バックアップを実行すると同時にバックアップファイルをユーザーオブジェクトストレージにエクスポートすることもできます。バックアップをエクスポートしている間、元のDBインスタンスのネットワーク性能の低下が発生する場合があります。

> [参考]
> 手動バックアップの場合、バックアップを実行した元DBインスタンスが削除されると、バックアップをエクスポートできません。

## 復元

バックアップを利用して希望の時点にデータを復元できます。復元時には常に新しいDBインスタンスが作成され、既存のDBインスタンスに復元することはできません。バックアップを実行した元のDBインスタンスと同じDBエンジンのバージョンにのみ復元できます。バックアップが作成された時点に復元するスナップショット復元、希望する特定の時点に復元する時点復元をサポートします。RDS for MySQLで作成したバックアップだけでなく、外部MySQLのバックアップにも復元できます。

> [注意]
> 復元するDBインスタンスのストレージサイズがバックアップを実行した元のDBインスタンスのストレージサイズより小さい場合や、元のDBインスタンスのパラメータグループと異なるパラメータグループを使用する場合、復元に失敗することがあります。

### スナップショット復元

スナップショット復元は、バックアップを実行した時点に復元します。バックアップファイルだけで復元を行い、バックアップを行った元のDBインスタンスが必要ありません。

### 時点復元

時点復元を利用して、希望する特定の時点またはバイナリログ(binary log)の特定の位置に復元できます。時点復元をするためには、バックアップファイルとバックアップを実行した時点から復元を希望する時点までのバイナリログ(binary log)が必要です。バイナリログ(binary log)は、バックアップが行われる元DBインスタンスのストレージに保存されます。バイナリログ(binary log)の保管期間が短い場合、ストレージ容量をより多く使うことがありますが、希望する時点への復元が難しい場合があります。下記の場合、時点復元に必要なバイナリログ(binary log)がないため、希望の時点に復元できない場合があります。

* 容量確保のために元DBインスタンスのバイナリログ(binary log)を削除した場合。
* バイナリログ(binary log)保管期間に基づいてMySQLによって自動的にバイナリログ(binary log)が削除された場合
* 高可用性DBインスタンスのフェイルオーバーによりバイナリログ(binary log)が削除された場合。
* その他様々な理由でバイナリログ(binary log)が破損したり、削除されている場合。

### 外部MySQLバックアップを利用した復元

外部MySQLバックアップファイルを利用してDBインスタンスを作成できます。外部MySQLバックアップファイルを作成する時、[バックアップ](backup-and-restore/#_1)項目を参照してRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。

> [注意]
> innodb_data_file_pathの設定値がibdata1:12M:autoextendでない場合、RDS for MySQLのDBインスタンスに復元できません。

(1) MySQLがインストールされたサーバーで下記のコマンドを利用してバックアップを実行します。

**XtraBackup 2.4.xx例**

```
innobackupex --defaults-file={my.cnfパス} --user {ユーザー} --password '{パスワード}' --socket {MySQLソケットファイルのパス} --compress --compress-threads=1 --stream=xbstream {バックアップファイルが作成されるディレクトリ} 2>>{バックアップログファイルのパス} > {バックアップファイルのパス}
```

**XtraBackup 8.0.xx例**

```
xtrabackup --defaults-file={my.cnfパス} --user={ユーザー} --password='{パスワード}' --socket={MySQLソケットファイルのパス} --compress --compress-threads=1 --stream=xbstream --backup {バックアップファイルが作成されるディレクトリ} 2>>{バックアップログファイルのパス} > {バックアップファイルのパス}
```

(2)バックアップログファイルの最後の行に`completed OK!があるか確認します。`completed OK!`がない場合は、バックアップが正常に終了していないため、ログファイルにあるエラーメッセージを参照してバックアップを再度行います。

(3)完了したバックアップファイルをオブジェクトストレージにアップロードします。

* 一度にアップロードできる最大ファイルサイズは5GBです。
* バックアップファイルのサイズが5GBより大きい場合、splitのようなユーティリティを利用してバックアップファイルを5GB以下に分割した後、マルチパートでアップロードする必要があります。
* 詳細については、 [マルチパートアップロード](/Storage/Object%20Storage/ko/api-guide/#_44)を参照してください。

(4)復元するプロジェクトのWebコンソールに接続した後、DBインスタンスタブで**オブジェクトストレージにあるバックアップで復元**ボタンをクリックします。

> [注意]
> 現在5.7.33バージョンでは、オブジェクトストレージのバックアップファイルを利用したDBインスタンスの復元は制限されます。
> 推奨するXtraBackup以外のバージョンを使用すると、正常に動作しない場合があります。
> オブジェクトストレージのバックアップファイルと復元しようとするMySQLのバージョンは同じでなければなりません。

### RDS for MySQLのバックアップを利用した復元

RDS for MySQLのバックアップファイルを利用して直接MySQLのデータベースを復元することができます。RDS for MySQLのバックアップファイルを復元する時、[バックアップ](backup-and-restore/#_1)項目を参照してRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。

(1) [バックアップのエクスポート](backup-and-restore/#_5)の項目を参照して、RDS for MySQLのバックアップをオブジェクトストレージにエクスポートします。

(2)オブジェクトストレージのバックアップを復元したいサーバーにダウンロードします。

(3) MySQLサービスを停止します。

(4) MySQLデータ保存パスのすべてのファイルを削除します。

```
rm -rf {MySQLデータ保存パス}/*
```

(5)ダウンロードしたバックアップファイルを解凍して復元します。

**XtraBackup 2.4.xxの例**

```
cat {バックアップファイル保存パス} | xbstream -x -C {MySQLデータ保存パス}
innobackupex --decompress {MySQLデータ保存パス}
innobackupex --defaults-file={my.cnfパス} --apply-log {MySQLデータ保存パス}
```

**XtraBackup 8.0.xxの例**

```
cat {バックアップファイルの保存パス} | xbstream -x -C {MySQLデータ保存パス}
xtrabackup --decompress --target-dir={MySQLデータの保存パス}
xtrabackup --prepare --target-dir={MySQLデータ保存パス}
xtrabackup --defaults-file={my.cnfパス} --copy-back --target-dir={MySQLデータ保存パス}
```

(6)解凍後、不要なファイルを削除します。

```
find {MySQLデータ保存パス} -name "*.qp" -print0 | xargs -0 rm
```

(7) MySQLサービスを起動します。
