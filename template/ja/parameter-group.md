## Database > RDS for {{engine.pascalCase}} > パラメータグループ

## パラメータグループ

RDS for {{engine.pascalCase}}はDBインスタンスにインストールされた{{engine.pascalCase}}の設定を適用するためにパラメータグループ機能を提供します。パラメータグループは{{engine.pascalCase}}を設定できるパラメータの集合です。サービス起動時、すべてのDBエンジンのバージョン別に基本パラメータグループを提供します。基本パラメータグループは`default.{DBエンジンバージョン名}`で提供され、バージョン別に推奨する基本パラメータ値で構成されています。基本パラメータグループは一般パラメータグループと同じように修正したり、削除することができます。

### パラメータグループの作成

必要に応じてパラメータコンソールでパラメータグループを作成できます。パラメータグループはDBエンジンバージョンごとに作成し、名前を付与することができ、下記のような制約事項があります。

* パラメータグループ名はリージョンごとに一意でなければなりません。
* パラメータグループの名前は1～100の間の英字、数字、一部の記号(-, _, .)だけを使用することができ、最初の文字は英字のみ使用できます。

パラメータグループの作成時、パラメータは常にデフォルト値で作成されます。既存のパラメータグループを基準に作成するには、パラメータコピー機能を利用してパラメータグループを作成する必要があります。

### パラメータグループのコピー

既存のパラメータグループを基準に新規パラメータグループを作成します。コピーした新規パラメータグループは、元のパラメータグループのパラメータ値で構成されます。元のパラメータグループとコピーしたパラメータグループの間には、いかなる関係もなく、元のパラメータグループの変更や削除は、コピーしたパラメータグループにいかなる影響も与えません。

### パラメータグループのリセット

パラメータグループをリセットすると、すべてのパラメータの値をDBエンジンバージョンのデフォルト値に変更します。

<a id="apply"></a>
### パラメータグループの適用

DBインスタンスの作成または修正時、DBインスタンスに適用するパラメータグループを選択できます。1つのDBインスタンスに1つのパラメータグループが適用され、1つのパラメータグループは複数のDBインスタンスに適用できます。パラメータグループのパラメータが変更されると、その変更はすぐにDBインスタンスに適用されません。接続されたDBインスタンスが存在する場合、パラメータグループは`適用必要`状態に変更されます。DBインスタンスリスト画面でパラメータグループと接続されたDBインスタンスを選択した後、**パラメータグループの変更内容を適用**をクリックしてパラメータの変更をDBインスタンスに反映できます。接続されたすべてのDBインスタンスにパラメータグループの変更が適用されると、パラメータグループは`適用完了`状態に変更されます。

> [注意]
> 再起動が必要なパラメータが変更された場合、適用過程でDBインスタンスが再起動されます。

### パラメータグループの比較

コンソールで異なる2つのパラメータグループを選択した後、**比較**をクリックすると、パラメータが何が違うかを確認できます。同じDBエンジンだけでなく、異なるDBエンジンバージョンのパラメータグループも比較できます。

### パラメータグループの削除

DBインスタンスに適用しているパラメータグループ以外は、自由に削除できます。DBインスタンスに適用しているパラメータグループを削除するには、削除する前に接続されたすべてのDBインスタンスのパラメータグループを先に変更する必要があります。

## パラメータ

パラメータは下記のような情報を含んでいます。

| 項目     | 説明                                                                                                                              |
|--------|---------------------------------------------------------------------------------------------------------------------------------|
| グループ   | オプションファイル(my.cnf)のオプショングループです。                                                                                                  |
| 名前     | オプションファイル(my.cnf)のオプション名です。<br/>オプション名とシステム変数(System Variables)が異なる場合、(**_- Variable_**: `システム変数(System Variables)`)形式で追加表示します。 |
| 値      | パラメータに適用する値です。                                                                                                                  |
| 許可された値 | パラメータに適用できる値の範囲です。<br/>                                                                                                         |
| 適用タイプ  | `固定`と`動的`に区分されます。<br/>`固定`の場合、パラメータ変更事項を適用するにはDBインスタンスを再起動する必要があります。<br/>`動的`の場合、DBインスタンスを再起動しなくてもパラメータが適用されます。                 |
| データ形式  | パラメータ値の形式を示します。                                                                                                                 | 
| 数式の使用  | 数式を使用するかどうかを示します。                                                                                                               |

### パラメータ変数、数式および関数

特定のパラメータは固定された値を使うより、DBインスタンスと関連付けられた値を利用した式で表現する方が良い場合があります。これをサポートするために、`NUMERIC`、`INTEGER`データ形式については、あらかじめ定義された変数、式、関数を使用できます。

* 数式
    * `()`, `+`, `-`, `*`, `/`を使用できます。
    * 数式の結果は常に数字でなければなりません。
    * データ形式が`INTEGER`の場合、小数点以下は切り捨てます。
    * データ形式が`NUMERIC`の場合、小数点以下を四捨五入します。
* 関数
    * `max(a, b, ...)`:複数の値の中から最も大きい値を返します。
    * `min(a, b, ...)`:複数の値の中から最も小さい値を返します。
    * `sum([a, b, ...])`:複数の値の合計を返します。
* 変数
    * `ramSizeByte`:現在DBインスタンスタイプのメモリサイズのバイト値を表します。
    * `vCPU`:現在DBインスタンスタイプの仮想CPUコア数を表します。
    * `dbPort`:現在DBインスタンスのDBポートを表します。
    * `serverId`:現在DBインスタンスに付与したサーバーIDを表します。
    * `readOnly`:現在DBインスタンスが読み取り専用の場合`1`、または`0`を表します。

以下の例は`innodb_buffer_pool_size`パラメータのデフォルト値で、DBインスタンスタイプのメモリサイズの6/10サイズに設定することを表します。

```
ramSizeByte * 6 / 10
```

### パラメータの変更

コンソールでパラメータグループを選択した後、**パラメータ編集**をクリックしてパラメータを変更できます。変更できないパラメータは、値が一般テキストで表示され、変更できるパラメータは、値を変更できるINPUTが表示されます。編集画面で**変更内容のプレビュー**をクリックすると、変更されたパラメータを確認できる別のポップアップ画面が表示され、**リセット**を押すと、変更する前に戻すことができます。編集モードで変更したすべての値は、**変更を保存**をクリックするとパラメータグループに反映されます。変更されたパラメータグループのDBインスタンスへの反映は[パラメータグループ適用](parameter-group/#apply)項目を参照してください。

{{#if (eq engine.lowerCase "mysql")}}
## GTIDの制約条件

GTIDモードでenforce_gtid_consistency=ONに設定すると、次の制約が適用されます。参考: [https://dev.mysql.com/doc/refman/8.4/en/replication-gtids-restrictions.html](https://dev.mysql.com/doc/refman/8.4/en/replication-gtids-restrictions.html)

### ENFORCE_GTID_CONSISTENCY

* OFF:制約対象クエリを許可
* WARN:制約対象クエリを許可するが、warning(警告)が発生
* ON:制約対象クエリを許可しない

### お客様への影響

> GTIDを利用したレプリケーションでは、以下の制限事項に該当するクエリは使用できなくなります(エラーが発生します)。
1. 非トランザクションストレージエンジンに関連する更新
    * MyISAMのような非トランザクションストレージエンジンに関連する更新と、InnoDBのようなトランザクションをサポートするストレージエンジンを使用する更新を、一つのトランザクション内で実行することはできません。
    * ソースとレプリカで、同じテーブルが異なるストレージエンジンを使用している場合にも問題が発生します。
    * 非トランザクションテーブルで動作するように定義されたトリガーが、同様の問題を引き起こす可能性があります。
2. CREATE TABLE ... SELECT構文(8.0.21以前のバージョンの場合)
3. binlog_formatがSTATEMENTの場合、トランザクション/プロシージャ/関数/トリガーの内部で一時テーブルを作成/削除することはできません。

### お客様に推奨される事前措置

1. 可能な限り、MyISAMのような非トランザクションストレージエンジンは使用しないでください。使用する場合は、InnoDBのようなトランザクションストレージエンジンとの更新を一つのトランザクションで実行しないでください。
2. CREATE TABLE ... SELECT構文(8.0.21以前のバージョンの場合)は使用しないでください。
    ```
   例)  
    create table tbl_backup as select * from tbl_ori; 
    を次のように変える必要があります。
    create table tbl_backup like tbl_ori; insert tbl_backup select * from tbl_ori;
    ```

## GTID適用手順

### gtid_mode

| 値              | ソースでの動作   | レプリカでの動作  |
|:---------------|:----------|:----------|
| OFF            | GTID未適用   | GTID処理不可  |
| OFF_PERMISSIVE | GTIDも処理可能 | GTIDも処理可能 |
| ON_PERMISSIVE  | GTID適用    | GTID適用    |
| ON             | GTIDのみ処理  | GTIDのみ処理  |

### RDSでのGTID適用手順

GTIDを円滑に適用するためには、gtid_mode(GTIDの適用手順)とenforce_gtid_consistency(クエリ適用の制限手順)を、パラメータグループを通じて次の順序で適用する必要があります。
参考: [https://dev.mysql.com/doc/refman/8.4/en/replication-mode-change-online-enable-gtids.html](https://dev.mysql.com/doc/refman/8.4/en/replication-mode-change-online-enable-gtids.html)

| 手順 | 対象          | パラメータ設定                         | 動作                                      | 備考                                                                                         |
|:---|:------------|:--------------------------------|:----------------------------------------|:-------------------------------------------------------------------------------------------|
| 1  | 全てのDBインスタンス | enforce_gtid_consistency = WARN | GTID適用時に問題となるSQLでwarning(警告)が発生することを確認。 | パラメータグループ変更後に適用。<br>問題が予想されるSQLを警告で確認し、<br>APP側で修正します。<br>警告が発生しなくなるまで継続します。               |
| 2  | 全てのDBインスタンス | enforce_gtid_consistency = ON   | 問題となるSQLでエラーが発生。                        | パラメータグループ変更後に適用。<br>これ以降、GTIDで問題となるクエリは実行できなくなります。                                         |
| 3  | 全てのDBインスタンス | gtid_mode = OFF_PERMISSIVE      | レプリカがGTIDを処理できるよう準備。                    | パラメータグループ変更後に適用。<br>全てのレプリカが先にOFF_PERMISSIVEになることで、問題の発生を防ぎます。                             |
| 4  | 全てのDBインスタンス | gtid_mode = ON_PERMISSIVE       | ソースがGTIDを生成。                            | パラメータグループ変更後に適用。                                                                           |
| 5  | 全てのDBインスタンス | -                               | 残留ANONYMOUSトランザクションの確認。                 | `SHOW STATUS LIKE 'ONGOING_ANONYMOUS_TRANSACTION_COUNT';`<br>全てのサーバーで結果が0になることが、最低1回は必要です。 |
| 6  | 全てのDBインスタンス | gtid_mode = ON                  | 全てのトランザクションがGTIDのみを使用。                  | パラメータグループ変更後に適用。                                                                           |

> [注意]
> * 各手順でパラメータグループを変更した後は、必ず[パラメータグループの変更内容を適用](parameter-group/#apply)を実行する必要があります。
> * gtid_modeとenforce_gtid_consistencyパラメータを変更する際、DBインスタンスの再起動が必要になる場合があります。
> * GTIDの適用解除は、適用の逆の手順で進めます。
{{/if}}